name: Flutter CI

on:
  push:
    branches: [ main, 'comp/**', 'feat/**', 'fix/**' ]
  pull_request:
    branches: [ main ]

jobs:
  analyze-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Flutter
        run: |
          sudo apt-get update
          sudo apt-get install -y git curl unzip xz-utils
          git clone https://github.com/flutter/flutter.git -b stable --depth 1 /opt/flutter
          echo "/opt/flutter/bin" >> $GITHUB_PATH
          echo "/opt/flutter/bin/cache/dart-sdk/bin" >> $GITHUB_PATH
          /opt/flutter/bin/flutter --version

      - name: Cache Pub
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.yaml') }}

      - name: Install dependencies
        run: |
          cd app
          # Ensure Flutter tool has cached artifacts (may download engine artifacts)
          /opt/flutter/bin/flutter precache || true

          # Retry pub get up to 3 times to mitigate transient network/package server issues
          attempt=0
          until [ $attempt -ge 3 ]; do
            /opt/flutter/bin/flutter pub get && break
            attempt=$((attempt+1))
            echo "flutter pub get failed, retry #$attempt"
            sleep $((attempt*5))
          done
          if [ $attempt -ge 3 ]; then
            echo "flutter pub get failed after $attempt attempts"; exit 1
          fi

      - name: Privacy checks (fail if INTERNET permission or analytics deps)
        run: |
          set -e
          # Check Android manifests for INTERNET permission in production app folders only
          if grep -R --include="AndroidManifest.xml" -n "android.permission.INTERNET" app android 2>/dev/null | grep -v "temp_project" | grep -q .; then
            echo "ERROR: INTERNET permission found in AndroidManifest.xml (prod paths). This project is privacy-first and must not request INTERNET."; exit 1
          fi

          # Check iOS Info.plist for NSAllowsArbitraryLoads or other network allow-all keys
          if grep -R --include="Info.plist" -n "NSAppTransportSecurity\|NSAllowsArbitraryLoads" app ios 2>/dev/null | grep -v "temp_project" | grep -q .; then
            echo "WARNING: Potential network-related keys found in Info.plist. Please verify they are required."; exit 1
          fi

          # Check pubspec.yaml for common analytics/crash packages
          if grep -E "analytics|sentry|crashlytics|firebase_analytics|appcenter|rollbar" -n app/pubspec.yaml; then
            echo "ERROR: Found analytics/crash packages in pubspec.yaml. Privacy policy requires no telemetry."; exit 1
          fi

      - name: Format check
        run: |
          cd app
          /opt/flutter/bin/dart format --set-exit-if-changed .

      - name: Static analysis
        run: |
          cd app
          /opt/flutter/bin/flutter analyze

      - name: Run tests
        run: |
          cd app
          /opt/flutter/bin/flutter test --coverage

  build-test:
    runs-on: ubuntu-latest
    needs: analyze-and-test
    steps:
      - uses: actions/checkout@v4

      - name: Set up Flutter
        run: |
          sudo apt-get update
          sudo apt-get install -y git curl unzip xz-utils
          git clone https://github.com/flutter/flutter.git -b stable --depth 1 /opt/flutter
          echo "/opt/flutter/bin" >> $GITHUB_PATH
          echo "/opt/flutter/bin/cache/dart-sdk/bin" >> $GITHUB_PATH
          /opt/flutter/bin/flutter --version

      - name: Install dependencies
        run: |
          cd app
          /opt/flutter/bin/flutter precache || true

          attempt=0
          until [ $attempt -ge 3 ]; do
            /opt/flutter/bin/flutter pub get && break
            attempt=$((attempt+1))
            echo "flutter pub get failed, retry #$attempt"
            sleep $((attempt*5))
          done
          if [ $attempt -ge 3 ]; then
            echo "flutter pub get failed after $attempt attempts"; exit 1
          fi

      - name: Analyze and Test
        run: |
          cd app
          /opt/flutter/bin/flutter analyze
          /opt/flutter/bin/flutter test

      - name: Build APK (debug)
        run: |
          cd app
          /opt/flutter/bin/flutter build apk --debug

  native-build-test:
    name: Native build & test
    runs-on: ubuntu-latest
    needs: build-test
    steps:
      - uses: actions/checkout@v4

      - name: Install build essentials
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake

      - name: Build native blurcore and run native test
        working-directory: native
        run: |
          mkdir -p build && cd build
          cmake ..
          cmake --build . --target blurcore_test -j$(nproc)
          ./blurcore_test
